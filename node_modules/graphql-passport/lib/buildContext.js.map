{"version":3,"sources":["../src/buildContext.ts"],"names":["promisifiedAuthentication","req","res","name","options","p","Promise","resolve","reject","done","err","user","info","authFn","passport","authenticate","promisifiedLogin","login","buildCommonContext","additionalContext","isAuthenticated","isUnauthenticated","getUser","strategyName","Error","logout","buildContext","contextParams","connection","payload","context","sharedContext"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\nimport passport, { AuthenticateOptions } from 'passport';\nimport express from 'express';\nimport { ExecutionParams } from 'subscriptions-transport-ws';\nimport { AuthenticateReturn, IVerifyOptions } from './types';\n\nconst promisifiedAuthentication = <UserObjectType extends {}>(\n  req: express.Request,\n  res: express.Response,\n  name: string,\n  options: AuthenticateOptions,\n) => {\n  const p = new Promise<AuthenticateReturn<UserObjectType>>((resolve, reject) => {\n    const done = (err: Error | undefined, user: UserObjectType | undefined, info?: IVerifyOptions | undefined) => {\n      if (err) reject(err);\n      else resolve({ user, info });\n    };\n\n    const authFn = passport.authenticate(name, options, done);\n    return authFn(req, res);\n  });\n\n  return p;\n};\n\nconst promisifiedLogin = <UserObjectType extends {}>(\n  req: express.Request,\n  user: UserObjectType,\n  options?: AuthenticateOptions,\n) =>\n  new Promise<void>((resolve, reject) => {\n    const done = (err: Error | undefined) => {\n      if (err) reject(err);\n      else resolve();\n    };\n\n    req.login(user, options, done);\n  });\n\ninterface CommonRequest<UserObjectType extends {}>\n  extends Pick<Context<UserObjectType>, 'isAuthenticated' | 'isUnauthenticated'> {\n  user?: UserObjectType;\n}\n\nexport interface Context<UserObjectType extends {}> {\n  isAuthenticated: () => boolean;\n  isUnauthenticated: () => boolean;\n  getUser: () => UserObjectType;\n  authenticate: (strategyName: string, options?: object) => Promise<AuthenticateReturn<UserObjectType>>;\n  login: (user: UserObjectType, options?: object) => Promise<void>;\n  logout: () => void;\n  res?: express.Response;\n  req: CommonRequest<UserObjectType>;\n}\n\nconst buildCommonContext = <UserObjectType extends {}>(req: CommonRequest<UserObjectType>, additionalContext: {}) => ({\n  isAuthenticated: () => req.isAuthenticated(),\n  isUnauthenticated: () => req.isUnauthenticated(),\n  getUser: () => req.user,\n  authenticate: (strategyName: string) => {\n    throw new Error(`Authenticate (${strategyName}) not implemented for subscriptions`);\n  },\n  login: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  logout: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  req,\n  ...additionalContext,\n});\n\nexport interface ContextParams {\n  req: express.Request;\n  res: express.Response;\n  connection?: ExecutionParams;\n  payload?: unknown;\n}\n\n// function buildContext(contextParams: RegularContextParams): Context;\n// function buildContext(contextParams: SubscriptionContextParams): SubscriptionContext;\nconst buildContext = <UserObjectType extends {}, R extends ContextParams = ContextParams>(\n  contextParams: R,\n): Context<UserObjectType> => {\n  const {\n    req, // set for queries and mutations\n    res, // set for queries and mutations\n    connection, // set for subscriptions\n    payload, // set for subscriptions\n    ...additionalContext\n  } = contextParams;\n\n  if (connection) {\n    return buildCommonContext<UserObjectType>(connection.context.req, additionalContext);\n  }\n\n  // The UserObject is without the any in conflict: \"'User' is not assignable to type 'UserObjectType'\"\n  const sharedContext = buildCommonContext<UserObjectType>(req as any, additionalContext);\n  return {\n    ...sharedContext,\n    authenticate: (name: string, options: AuthenticateOptions) => promisifiedAuthentication(req, res, name, options),\n    login: (user: UserObjectType, options: AuthenticateOptions) => promisifiedLogin<UserObjectType>(req, user, options),\n    logout: () => req.logout(),\n    res,\n  };\n};\n\nexport default buildContext;\n"],"file":"buildContext.js"}