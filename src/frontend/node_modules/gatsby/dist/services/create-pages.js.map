{"version":3,"sources":["../../src/services/create-pages.ts"],"names":["createPages","parentSpan","gatsbyNodeGraphQLFunction","store","deferNodeMutation","activity","reporter","activityTimer","start","timestamp","Date","now","currentPages","Map","getState","pages","graphql","traceId","waitForCascadingActions","span","info","nodes","size","nodesByType","get","verbose","entries","map","type","join","end","deletedPages","length","tim","changedPages"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AAEA;;AAEO,eAAeA,WAAf,CAA2B;AAChCC,EAAAA,UADgC;AAEhCC,EAAAA,yBAFgC;AAGhCC,EAAAA,KAHgC;AAIhCC,EAAAA;AAJgC,CAA3B,EAQJ;AAAA;;AACD,gCAAYD,KAAZ;;AACA,QAAME,QAAQ,GAAGC,kBAASC,aAAT,CAAwB,aAAxB,EAAsC;AACrDN,IAAAA;AADqD,GAAtC,CAAjB;;AAGAI,EAAAA,QAAQ,CAACG,KAAT;AACA,QAAMC,SAAS,GAAGC,IAAI,CAACC,GAAL,EAAlB;AACA,QAAMC,YAAY,GAAG,IAAIC,GAAJ,CAA6BV,KAAK,CAACW,QAAN,GAAiBC,KAA9C,CAArB;AACA,QAAM,4BACH,aADG,EAEJ;AACEC,IAAAA,OAAO,EAAEd,yBADX;AAEEe,IAAAA,OAAO,EAAG,qBAFZ;AAGEC,IAAAA,uBAAuB,EAAE,IAH3B;AAIEjB,IAAAA,UAAU,EAAEI,QAAQ,CAACc,IAJvB;AAKEf,IAAAA;AALF,GAFI,EASJ;AAAEC,IAAAA;AAAF,GATI,CAAN;;AAYAC,oBAASc,IAAT,CACG,gBAAejB,KAAK,CAACW,QAAN,GAAiBO,KAAjB,CAAuBC,IAAK,qBAA5C,yBACEnB,KAAK,CAACW,QAAN,GAAiBS,WADnB,oFACE,sBAA8BC,GAA9B,CAAmC,UAAnC,CADF,2DACE,uBAA+CF,IAChD,gCAHH;;AAMAhB,oBAASmB,OAAT,CACG,yBACCtB,KAAK,CAACW,QAAN,GAAiBS,WAAjB,CAA6BD,IAC9B,qBAAoB,CAAC,GAAGnB,KAAK,CAACW,QAAN,GAAiBS,WAAjB,CAA6BG,OAA7B,EAAJ,EAClBC,GADkB,CACd,CAAC,CAACC,IAAD,EAAOP,KAAP,CAAD,KAAmBO,IAAI,GAAI,IAAR,GAAcP,KAAK,CAACC,IADzB,EAElBO,IAFkB,CAEZ,IAFY,CAEP,EALhB;;AAQAxB,EAAAA,QAAQ,CAACyB,GAAT;;AAEAxB,oBAASmB,OAAT,CAAkB,4BAAlB;;AAEA,QAAMM,YAAY,GAAG,wCAAqB5B,KAAK,CAACW,QAAN,GAAiBC,KAAtC,EAA6CN,SAA7C,CAArB;;AAEAH,oBAASmB,OAAT,CACG,WAAUM,YAAY,CAACC,MAAO,QAAOD,YAAY,CAACC,MAAb,KAAwB,CAAxB,GAA6B,EAA7B,GAAkC,GAAG,EAD7E;;AAIA,QAAMC,GAAG,GAAG3B,kBAASC,aAAT,CAAwB,4BAAxB,CAAZ;;AACA0B,EAAAA,GAAG,CAACzB,KAAJ;AAEA,QAAM;AAAE0B,IAAAA;AAAF,MAAmB,oCACvBtB,YADuB,EAEvBT,KAAK,CAACW,QAAN,GAAiBC,KAFM,CAAzB;;AAKAT,oBAASmB,OAAT,CACG,SAAQS,YAAY,CAACF,MAAO,gBAC3BE,YAAY,CAACF,MAAb,KAAwB,CAAxB,GAA6B,EAA7B,GAAkC,GACnC,EAHH;;AAKAC,EAAAA,GAAG,CAACH,GAAJ;AAEA,SAAO;AACLI,IAAAA,YADK;AAELH,IAAAA;AAFK,GAAP;AAID","sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { IDataLayerContext } from \"../state-machines/data-layer/types\"\nimport { assertStore } from \"../utils/assert-store\"\nimport { IGatsbyPage } from \"../redux/types\"\nimport { deleteUntouchedPages, findChangedPages } from \"../utils/changed-pages\"\n\nexport async function createPages({\n  parentSpan,\n  gatsbyNodeGraphQLFunction,\n  store,\n  deferNodeMutation,\n}: Partial<IDataLayerContext>): Promise<{\n  deletedPages: Array<string>\n  changedPages: Array<string>\n}> {\n  assertStore(store)\n  const activity = reporter.activityTimer(`createPages`, {\n    parentSpan,\n  })\n  activity.start()\n  const timestamp = Date.now()\n  const currentPages = new Map<string, IGatsbyPage>(store.getState().pages)\n  await apiRunnerNode(\n    `createPages`,\n    {\n      graphql: gatsbyNodeGraphQLFunction,\n      traceId: `initial-createPages`,\n      waitForCascadingActions: true,\n      parentSpan: activity.span,\n      deferNodeMutation,\n    },\n    { activity }\n  )\n\n  reporter.info(\n    `Total nodes: ${store.getState().nodes.size}, SitePage nodes: ${\n      store.getState().nodesByType?.get(`SitePage`)?.size\n    } (use --verbose for breakdown)`\n  )\n\n  reporter.verbose(\n    `Number of node types: ${\n      store.getState().nodesByType.size\n    }. Nodes per type: ${[...store.getState().nodesByType.entries()]\n      .map(([type, nodes]) => type + `: ` + nodes.size)\n      .join(`, `)}`\n  )\n\n  activity.end()\n\n  reporter.verbose(`Checking for deleted pages`)\n\n  const deletedPages = deleteUntouchedPages(store.getState().pages, timestamp)\n\n  reporter.verbose(\n    `Deleted ${deletedPages.length} page${deletedPages.length === 1 ? `` : `s`}`\n  )\n\n  const tim = reporter.activityTimer(`Checking for changed pages`)\n  tim.start()\n\n  const { changedPages } = findChangedPages(\n    currentPages,\n    store.getState().pages\n  )\n\n  reporter.verbose(\n    `Found ${changedPages.length} changed page${\n      changedPages.length === 1 ? `` : `s`\n    }`\n  )\n  tim.end()\n\n  return {\n    changedPages,\n    deletedPages,\n  }\n}\n"],"file":"create-pages.js"}